 {{/* ブログカードを生成 */}}

{{ $p := site.GetPage (.Get "path") }}
{{ if not $p }}
  <p>ページが見つかりません: {{ .Get "path" }}</p>
{{ else }}

  {{ $content := $p.RawContent }}

  {{/* 1. <img src="..."> */}}
  {{ $htmlImg := findRE `(?i)<img[^>]*?src="([^"]+)"` $content 1 }}

  {{/* 2. figure ショートコード（改行対応）*/}}
  {{ $figureImg := findRE `{{<\s*figure[\s\S]*?src="([^"]+)"[\s\S]*?>}}` $content 1 }}

  {{/* 3. img/image ショートコード（改行対応）*/}}
  {{ $shortImg := findRE `{{<\s*(?:img|image)[\s\S]*?src="([^"]+)"[\s\S]*?>}}` $content 1 }}

  {{/* 最初に拾えた生パス */}}
  {{ $raw := "" }}
  {{ if $htmlImg }}
    {{ $raw = index (index $htmlImg 0) 1 }}
  {{ else if $figureImg }}
    {{ $raw = index (index $figureImg 0) 1 }}
  {{ else if $shortImg }}
    {{ $raw = index (index $shortImg 0) 1 }}
  {{ end }}

  {{/* raw パスを Page Resource の絶対 URL に変換 */}}
  {{ $img := "" }}
  {{ if $raw }}
    {{/* "image/xxxx.jpg" に一致するリソースを探す */}}
    {{ $match := $p.Resources.Match (printf "**/%s" (path.Base $raw)) }}
    {{ if $match }}
      {{ $img = (index $match 0).Permalink }}
    {{ end }}
  {{ end }}

  {{/* fallback: 1枚目の page resource */}}
  {{ if eq $img "" }}
    {{ with $p.Resources.ByType "image" }}
      {{ $img = (index . 0).Permalink }}
    {{ end }}
  {{ end }}

  {{/* 本文冒頭70文字 */}}
  {{ $plain := $p.Plain }}
  {{ $summary := cond (gt (len $plain) 70) (printf "%s..." (substr $plain 0 70)) $plain }}

  <div class="refcard" style="border:2px solid #ddd; border-radius:8px; padding:12px; margin:16px 0; display:flex; gap:12px;">

    {{ if $img }}
      <div style="width:100px; flex-shrink:0;">
        <img src="{{ $img }}" alt="" style="width:100%; border-radius:6px;">
      </div>
    {{ end }}

    <div style="flex:1;">
      <a href="{{ $p.RelPermalink }}" style="font-size:1.0rem; font-weight:bold;">
        {{ $p.Title }}
      </a>
      <p style="margin-top:6px; color:#555;">
        {{ $summary }}
      </p>
    </div>
  </div>

{{ end }}
